#!/usr/bin/env python

import tarfile
import os
import sys       
    
exit(0)
    
#Number of weights   
arch1_N = 100
arch2_N = 50
log_path = '/home/boincadm/projects/boincdocker/validator_log.txt'


#Extract tgz archive
tgz_path = sys.argv[1]
directory = os.path.dirname(tgz_path)
with tarfile.open(tgz_path, 'r:gz') as tar:
    tar.extractall(path=directory)
    
#Rename output file to have same filename as tgz (i.e. result name)    
old_txt_file = os.path.join(directory, 'myOutput.txt')
new_txt_file = os.path.join(directory, os.path.basename(tgz_path)[:-4] + '.txt')
os.rename(old_txt_file, new_txt_file)

#Write to log file
with open(log_path, 'a') as f:
    f.write(tgz_path + ' ')

with open(new_txt_file, 'r') as f:
    numbers = [float(x) for x in f.read().split()]
   
#Extract architecture name
filename = os.path.basename(new_txt_file)
parts = filename.split("_")
arch_name = parts[2]

#Set how many weights to expect in valid answer
if arch_name == "arch1":
    N_to_check = arch1_N
elif arch_name == "arch2":
    N_to_check = arch2_N
else:
    with open(log_path, 'a') as f:
        f.write("FAILED: WRONG ARCHITECTURE NAME" + '\n')
    exit(1)

    
#WU is validated if the output has the same number of weights as the global model
if len(numbers) == N_to_check:    
    with open(log_path, 'a') as f:
        f.write("SUCCESS" + '\n')
            
    exit(0)
else:
    with open(log_path, 'a') as f:
        f.write("FAILED: NOT ENOUGH WEIGHTS" + '\n')
            
    exit(1)
 
